<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ludus</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados */
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Impede o scroll da página */
            width: 100vw;
            height: 100vh;
            background-color: #111827; /* bg-gray-900 */
        }

        /* Classe de ajuda para esconder a UI (Modo Foco) */
        body.ui-hidden .hide-on-focus {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #board {
            width: 100vw;
            height: 100vh;
            background-color: #333; /* Fundo escuro padrão */
            position: relative;
            overflow: hidden;
            touch-action: none; /* Desativa ações de toque padrão (como scroll) */
            cursor: grab; /* Indica que o board pode ser "agarrado" */
            z-index: 0; /* Camada base */
        }
        #board.panning {
            cursor: grabbing; /* Cursor ao arrastar (pan) */
        }
        /* Cursor para Adicionar Luz */
        #board.light-mode {
            cursor: crosshair;
        }


        #canvas-container {
            position: absolute;
            transform-origin: 0 0; /* Ponto de origem para zoom/scale */
            /* Padrão de grade sutil para o canvas antes de carregar um mapa */
            background-image: linear-gradient(to right, rgba(255, 255, 255, 0.07) 1px, transparent 1px),
                            linear-gradient(to bottom, rgba(255, 255, 255, 0.07) 1px, transparent 1px);
            background-size: 25px 25px;
            background-position: center;
            /* Um tamanho inicial grande para o "mundo" */
            width: 3000px; 
            height: 3000px;
        }
        
        /* Camada de Esconder Mapa */
        #map-cover-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* Será ajustado para o tamanho do mapa via JS */
            height: 100%; /* Será ajustado para o tamanho do mapa via JS */
            pointer-events: none; /* Por padrão, não bloqueia cliques */
            z-index: 30; /* Acima do mapa e tokens */
            transition: opacity 0.3s ease;
        }
        
        /* Camada de Luzes Dinâmicas */
        #dynamic-light-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Container não bloqueia */
            z-index: 25; /* Acima dos tokens (20), abaixo da cobertura (30) */
        }
        .dynamic-light {
            position: absolute;
            border-radius: 50%;
            pointer-events: auto; /* Luzes são clicáveis e arrastáveis */
            cursor: grab;
            transition: box-shadow 0.2s, background-color 0.2s, width 0.2s, height 0.2s, transform 0.2s;
            mix-blend-mode: screen; 
            opacity: 0.8;
        }
        .dynamic-light.selected {
            border: 2px dashed #0ea5e9;
        }
        .dynamic-light:active {
            cursor: grabbing;
        }
        
        /* Animações de Luz */
        @keyframes pulse-suave {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        .pulse-suave { animation: pulse-suave 3s ease-in-out infinite; }
        
        @keyframes flicker-vela {
            0% { opacity: 0.6; } 20% { opacity: 1; } 40% { opacity: 0.7; }
            60% { opacity: 0.9; } 80% { opacity: 0.6; } 100% { opacity: 0.8; }
        }
        .flicker-vela { animation: flicker-vela 1.5s linear infinite; }
        
        @keyframes fogueira {
            0% { opacity: 0.8; transform: scale(1) translate(-50%, -50%); }
            25% { opacity: 1; transform: scale(1.05) translate(-50%, -50%); }
            50% { opacity: 0.7; transform: scale(0.95) translate(-50%, -50%); }
            75% { opacity: 0.9; transform: scale(1.02) translate(-50%, -50%); }
            100% { opacity: 0.8; transform: scale(1) translate(-50%, -50%); }
        }
        .fogueira { animation: fogueira 2s ease-in-out infinite; }


        .token {
            position: absolute;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            transition: outline 0.1s ease-in-out, box-shadow 0.1s ease-in-out, filter 0.2s ease, transform 0s; /* Rotação não deve ser suave */
            z-index: 20; /* Acima do mapa, abaixo da camada de luz */
            /* Filtros de Aura (drop-shadow) são aplicados aqui via JS */
        }
        
        /* Regra de Z-index para arrastar (apenas se a UI estiver visível) */
        body:not(.ui-hidden) .token.dragging {
            cursor: grabbing;
            z-index: 1000; /* Acima de tudo ao arrastar */
        }
        .token.selected {
            /* O feedback agora é a caixa de transformação */
        }
        
        /* Esconde a outline se o body tiver a classe 'ui-hidden' */
        body.ui-hidden .token.selected {
            outline: none;
            box-shadow: none;
        }
        
        /* Esconde a caixa de transformação no modo foco */
        body.ui-hidden #transform-box {
            display: none !important;
        }


        /* Efeito de Movimento: Respiração */
        @keyframes breathing-normal {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-3px); }
        }
        .breathing-normal { animation: breathing-normal 2.5s ease-in-out infinite; }
        
        @keyframes breathing-agitated {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-6px); }
        }
        .breathing-agitated { animation: breathing-agitated 1.5s ease-in-out infinite; }
        
        /* Efeito de Movimento: Tremer (Shake) */
        @keyframes shake-sm { 0%, 100% { transform: translate(0, 0); } 33% { transform: translate(2px, 1px); } 66% { transform: translate(-2px, -1px); } }
        .shake-sm { animation: shake-sm 0.3s infinite; }
        @keyframes shake-md { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(8px, 2px); } 75% { transform: translate(-8px, -2px); } }
        .shake-md { animation: shake-md 0.3s infinite; }
        @keyframes shake-lg { 0%, 100% { transform: translate(0, 0) rotate(0); } 40% { transform: translate(-10px, 5px) rotate(-5deg); } 80% { transform: translate(10px, -5px) rotate(5deg); } }
        .shake-lg { animation: shake-lg 0.3s infinite; }
        
        /* NOVAS Animações de Pulsar */
        @keyframes pulse-normal {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .pulse-normal { animation: pulse-normal 2s ease-in-out infinite; }

        @keyframes pulse-agitated {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pulse-agitated { animation: pulse-agitated 1s ease-in-out infinite; }
        

        /* Camada de Imagem (para máscara) */
        .token-image-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            mask-size: contain;
            mask-position: center;
            mask-repeat: no-repeat;
            z-index: 1; /* Camada base */
            transition: transform 0s; /* Rotação não deve ser suave */
        }

        /* Camada de Luz Interna (para máscara) */
        .token-light-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5; /* Em cima da imagem base */
            transition: box-shadow 0.2s ease-in-out, transform 0s;
            mask-size: contain;
            mask-position: center;
            mask-repeat: no-repeat;
        }
        
        /* Camada de Animação/Efeito (ex: fogo) */
        .token-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none;
            opacity: 0.8;
            z-index: 21; /* Acima da imagem e luz */
            transition: transform 0s;
        }

        
        /* --- SLIDERS --- */
        input[type=range] {
          -webkit-appearance: none;
          appearance: none;
          width: 100%;
          height: 0.5rem;
          background: #4b5563; /* bg-gray-600 */
          border-radius: 0.25rem;
          outline: none;
          opacity: 0.7;
          transition: opacity .2s;
        }
        input[type=range]:hover {
          opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 1rem;
          height: 1rem;
          background: #6366f1; /* bg-indigo-500 */
          cursor: pointer;
          border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
          border: none;
          background-color: #6366f1; /* bg-indigo-500 */
          height: 1rem;
          width: 1rem;
          border-radius: 50%;
        }

        /* --- Estilos de Estados de Token (Visual) --- */
        .state-slot {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #374151; /* bg-gray-700 */
            border-radius: 0.375rem; /* rounded-md */
            background-size: cover;
            background-position: center;
            border: 2px dashed transparent;
        }
        .state-slot.preview-only {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .state-slot-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s, border-color 0.2s;
            background-size: cover;
            background-position: center;
        }
        .state-slot-label:not(.has-image) {
            border: 2px dashed #4b5563; /* bg-gray-600 */
        }
        .state-slot-label:not(.has-image):hover {
            border-color: #6366f1; /* bg-indigo-500 */
            background-color: rgba(255,255,255,0.05);
        }
        /* Esconde o plus icon quando tem imagem */
        .state-slot-label.has-image svg {
            display: none;
        }
        .state-clear-btn-visual {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            border: 2px solid #1f2937; /* bg-gray-800 */
            display: none; /* Escondido por defeito */
            transition: transform 0.1s;
        }
        .state-clear-btn-visual:hover {
            transform: scale(1.1);
        }
        .state-slot-label.has-image + .state-clear-btn-visual {
            display: flex; /* Mostra apenas se tiver imagem */
        }
        
        .token.in-rotate-mode {
            /* (Nada) */
        }

        /* --- Caixa de Transformação --- */
        #transform-box {
            position: absolute;
            border: 2px solid #0ea5e9; /* Borda azul */
            pointer-events: none; /* Permite cliques "através" da caixa */
            display: none; /* Escondido por defeito */
            z-index: 40; /* Acima do token (20) */
        }
        .transform-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #0ea5e9; /* border-blue-500 */
            border-radius: 2px;
            pointer-events: auto; /* Alvos clicáveis */
            z-index: 41;
        }
        /* Cantos (Escala) */
        .handle-nw { cursor: nwse-resize; top: -6px; left: -6px; }
        .handle-ne { cursor: nesw-resize; top: -6px; right: -6px; }
        .handle-sw { cursor: nesw-resize; bottom: -6px; left: -6px; }
        .handle-se { cursor: nwse-resize; bottom: -6px; right: -6px; }
        
        /* Rotação */
        .handle-rotate {
            cursor: grab;
            top: -25px; /* Puxa para cima */
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #f9fafb;
            border: 1px solid #0ea5e9;
        }
        .handle-rotate:active {
            cursor: grabbing;
        }
        /* Linha para o puxador de rotação */
        .handle-rotate::before {
            content: '';
            position: absolute;
            width: 1px;
            height: 15px;
            background-color: #0ea5e9;
            top: 13px; /* Começa no fundo do círculo */
            left: 50%;
            transform: translateX(-50%);
        }

        /* --- Tooltip --- */
        .tooltip {
            position: absolute;
            left: 110%; /* Posiciona à direita do ícone */
            top: 50%;
            transform: translateY(-50%) scale(0.9);
            background-color: #111827; /* bg-gray-900 */
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            white-space: nowrap;
            font-weight: 500;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none;
            z-index: 2000; /* Acima de tudo */
        }
        .group:hover .tooltip {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        /* --- Painel de Rolagem de Dados --- */
        #dice-roller-panel {
            z-index: 110; /* Acima do painel principal */
        }
        #dice-log {
            height: 150px;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.3);
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            flex-direction: column-reverse; /* Novos resultados em cima */
        }
        #dice-log p {
            margin-bottom: 0.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* --- Painel de Inventário --- */
        #object-inventory-panel {
            transition: transform 0.3s ease-in-out;
            z-index: 90; /* Atrás do painel principal */
        }
        #inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); /* Itens mais pequenos */
            gap: 1rem; /* Mais espaçamento */
            padding: 1rem; /* Mais padding */
            overflow-y: auto;
            flex-grow: 1; 
        }
        /* Estilo da barra de scroll do inventário */
        #inventory-grid::-webkit-scrollbar {
            width: 8px;
        }
        #inventory-grid::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        #inventory-grid::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        #inventory-grid::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        
        .inventory-item {
            position: relative;
            border-radius: 0.375rem;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .inventory-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.5); /* Sombra azul ao passar o rato */
        }
        .inventory-item:active {
            cursor: grabbing;
        }
        .inventory-item .preview {
            width: 100%;
            aspect-ratio: 1/1;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: none; /* Permite arrastar o item principal */
            background-color: #374151; /* bg-gray-700 */
            border-radius: 0.375rem; /* rounded-md */
        }
        .inventory-item span {
            font-size: 0.75rem;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            display: block;
            pointer-events: none;
            /* Nome sobreposto com gradiente */
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 8px 6px 4px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
            text-align: left;
        }
        .inventory-delete-btn {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: #ef4444; /* bg-red-500 */
            color: white;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            border: 2px solid #1f2937; /* bg-gray-800 */
            transform: scale(0.9);
            opacity: 0; /* Escondido por defeito */
            transition: all 0.2s;
        }
        .inventory-item:hover .inventory-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .inventory-delete-btn svg {
            width: 0.75rem;
            height: 0.75rem;
        }
        
        /* --- Notificações Toast --- */
        #notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .notification {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: fadeInOut 3s ease-in-out forwards;
        }
        .notification.success {
            background-color: #22c55e; /* bg-green-500 */
        }
        .notification.error {
            background-color: #ef4444; /* bg-red-500 */
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        /* --- Menu de Contexto --- */
        #custom-context-menu {
            position: fixed;
            z-index: 4000; /* Acima de tudo */
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #4b5563; /* bg-gray-600 */
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            padding: 6px;
            display: none; /* Escondido por defeito */
        }
        #custom-context-menu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            color: white;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        #custom-context-menu button:hover {
            background-color: #6366f1; /* bg-indigo-500 */
        }
        
        /* --- Painel de Atalhos --- */
        #shortcuts-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4500; /* Acima do menu de contexto, abaixo das notificações */
            background-color: rgba(31, 41, 55, 0.8); /* bg-gray-800/80 */
            backdrop-filter: blur(10px);
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: white;
            width: 90%;
            max-width: 400px;
        }
        #shortcuts-modal kbd {
            background-color: #4b5563; /* bg-gray-600 */
            border-radius: 0.25rem;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.875rem;
            border-bottom: 2px solid #374151; /* bg-gray-700 */
        }
        
        /* Cor de seleção do ícone de Luz */
        #light-tool-btn.active {
            background-color: #3b82f6; /* bg-blue-500 */
        }


    </style>
</head>
<body class="bg-gray-900">

    <!-- Logo Ludus -->
    <img id="ludus-logo" src="" alt="Ludus Logo" class="fixed top-[12000px] left-[30px] w-[60px] h-auto z-50 hide-on-focus transition-opacity duration-300">

    <!-- Container de Notificações -->
    <div id="notification-container"></div>

    <!-- O Tabuleiro (Board) -->
    <div id="board">
        <!-- Container do Mapa e Tokens (para zoom/pan) -->
        <div id="canvas-container">
            <!-- Camada de Luzes Dinâmicas -->
            <div id="dynamic-light-container">
                <!-- Luzes serão adicionadas aqui -->
            </div>
            
            <!-- Camada de Esconder Mapa -->
            <canvas id="map-cover-canvas"></canvas>
            
            <!-- Caixa de Transformação -->
            <div id="transform-box">
                <div class="transform-handle handle-nw" data-action="scale" data-corner="nw"></div>
                <div class="transform-handle handle-ne" data-action="scale" data-corner="ne"></div>
                <div class="transform-handle handle-sw" data-action="scale" data-corner="sw"></div>
                <div class="transform-handle handle-se" data-action="scale" data-corner="se"></div>
                <div class="transform-handle handle-rotate" data-action="rotate"></div>
            </div>
            
            <!-- Tokens serão adicionados aqui pelo JS -->
        </div>
    </div>

    <!-- Painel de UI Moderno (Flutuante) -->
    <div id="modern-panel" class="fixed top-4 left-4 h-auto w-16 bg-gray-900/70 backdrop-blur-md border border-white/20 text-white shadow-lg flex flex-col items-center py-4 gap-4 z-100 hide-on-focus transition-opacity duration-300 rounded-2xl">
        
        <!-- Grupo de Ações Principais -->
        <div class="flex flex-col gap-4">
            
            <!-- Carregar Mapa -->
            <label for="mapInput" class="group relative">
                <input type="file" id="mapInput" class="hidden" accept="image/*">
                <span class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg cursor-pointer hover:bg-blue-600 transition-colors" title="Carregar Mapa">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </span>
                <span class="tooltip">Carregar Mapa</span>
            </label>

            <!-- Adicionar Token -->
            <label for="tokenInput" class="group relative">
                <input type="file" id="tokenInput" class="hidden" accept="image/*">
                <span class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg cursor-pointer hover:bg-green-600 transition-colors" title="Adicionar Token">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </span>
                <span class="tooltip">Adicionar Token</span>
            </label>
            
            <!-- Guardar Cena -->
            <button id="save-state-btn" class="group relative w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg hover:bg-indigo-600 transition-colors" title="Guardar Cena (G)">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span class="tooltip">Guardar Cena (G)</span>
            </button>

            <!-- Carregar Cena -->
            <label for="load-state-input" class="group relative">
                <input type="file" id="load-state-input" class="hidden" accept=".json">
                <span class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg cursor-pointer hover:bg-yellow-600 transition-colors" title="Carregar Cena">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </span>
                <span class="tooltip">Carregar Cena</span>
            </label>
        </div>
        
        <!-- Divisor -->
        <hr class="w-10 border-gray-600 my-2">
        
        <!-- Grupo de Ferramentas -->
        <div class="flex flex-col gap-4">
            
            <!-- Esconder/Mostrar Mapa -->
            <button id="map-cover-toggle-btn" class="group relative w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg hover:bg-gray-500 transition-colors" title="Esconder/Mostrar Mapa (E)">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                <span class="tooltip">Esconder/Mostrar Mapa (E)</span>
            </button>
            
            <!-- Ferramenta de Luz -->
            <button id="light-tool-btn" class="group relative w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg hover:bg-blue-500 transition-colors" title="Adicionar Luz (L)">
                <!-- ÍCONE ATUALIZADO (Mais simples) -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 12a3 3 0 110-6 3 3 0 010 6z" />
                </svg>
                <span class="tooltip">Adicionar Luz (L)</span>
            </button>
            
            <!-- Rolador de Dados -->
            <button id="dice-toggle-btn" class="group relative w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg hover:bg-purple-600 transition-colors" title="Rolador de Dados (D)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H10a1 1 0 01-1-1v-4z" />
                </svg>
                <span class="tooltip">Rolador de Dados (D)</span>
            </button>
            
            <!-- Inventário de Objetos -->
            <button id="inventory-toggle-btn" class="group relative w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg hover:bg-yellow-500 transition-colors" title="Inventário de Objetos (I)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                </svg>
                <span class="tooltip">Inventário de Objetos (I)</span>
            </button>
        </div>
        
        <!-- Divisor e Botão de Ajuda -->
        <hr class="w-10 border-gray-600 my-2">
        
        <div class="flex flex-col gap-4">
            <button id="shortcuts-toggle-btn" class="group relative w-10 h-10 flex items-center justify-center bg-gray-700 rounded-lg hover:bg-cyan-500 transition-colors" title="Ajuda / Atalhos (H)">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
                </svg>
                <span class="tooltip">Ajuda / Atalhos (H)</span>
            </button>
        </div>
    </div>

    <!-- Painel Flutuante (Outline) de Controlo do Token -->
    <div id="scaler-ui" class="hidden fixed z-[50] flex flex-row gap-2 p-1.5 bg-black/20 backdrop-blur-md shadow-lg border border-white/20 rounded-lg hide-on-focus transition-opacity duration-300">
        
        <!-- Ícone de "Ajustes" -->
        <button id="config-token-btn" class="w-8 h-8 bg-gray-700 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-purple-600" title="Configurações">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527c.47-.336 1.06-.336 1.53 0l.772.772c.47.47.47 1.23 0 1.7l-.527.737c-.25.35-.272.806-.108 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.11v1.093c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.108 1.204l.527.738c.47.47.47 1.23 0 1.7l-.772.772c-.47.47-1.06.47-1.53 0l-.737-.527c-.35-.25-.806-.272-1.204-.108-.397.165-.71.505-.78.93l-.15.893c-.09.543-.56.94-1.11.94h-1.093c-.55 0-1.02-.397-1.11-.94l-.149-.893c-.07-.425-.383-.765-.78-.93-.398-.165-.854-.143-1.204.108l-.738.527c-.47.47-1.23.47-1.7 0l-.772-.772c-.47-.47-.47-1.23 0-1.7l.527-.737c.25-.35.272.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.11v-1.093c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.764-.383.93-.78.165-.398.143-.854-.108-1.204l-.527-.738c-.47-.47-.47-1.23 0-1.7l.772-.772c.47-.47 1.06-.47 1.53 0l.737.527c.35.25.807.272 1.204.108.397-.165.71-.505.78-.93l.15-.893zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" />
            </svg>
        </button>
        
        <!-- Botões de Transformação -->
        <button id="flip-h-btn" class="w-8 h-8 bg-gray-700 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600" title="Girar Horizontal">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16 7H4m12 0l-4 4m4-4l-4-4m5 9v4m0 0l4-4m-4 4l-4-4" />
            </svg>
        </button>
        <button id="flip-v-btn" class="w-8 h-8 bg-gray-700 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600" title="Girar Vertical">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 12L3 8m4 8l4-8m1 9l4 4m0 0l4-4m-4 4V4" />
            </svg>
        </button>
        
        <!-- Botão Deletar Rápido -->
        <button id="quick-delete-btn" class="w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-red-700" title="Deletar Token (Del)">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        </button>
    </div>

    <!-- Painel de Configurações de Token (Lateral Direita) -->
    <div id="token-config-panel" class="fixed top-0 right-0 h-screen w-80 bg-gray-900/80 backdrop-blur-md border-l border-white/20 text-white shadow-lg z-[1900] transform translate-x-full transition-transform duration-300 overflow-y-auto hide-on-focus">
        <div class="p-6">
            <!-- Cabeçalho do Painel -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Configurações do Token</h2>
                <button id="close-panel-btn" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Secção Nome -->
            <div class="mb-6">
                <div class="flex items-center gap-2 text-gray-300 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.5 20.25a7.5 7.5 0 0115 0" />
                    </svg>
                    <label for="token-name-input" class="block text-sm font-medium">Nome do Token:</label>
                </div>
                <input type="text" id="token-name-input" class="mt-1 block w-full rounded-md shadow-sm bg-gray-700 border-gray-600 text-white p-2">
            </div>

            <!-- Secção de Estados do Token -->
            <div class="p-3 bg-gray-900/50 rounded-lg mb-6">
                <div class="flex items-center gap-2 text-gray-300 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a4 4 0 014-4h10a4 4 0 014 4v12a4 4 0 01-4 4H7zM12 3v18" />
                    </svg>
                    <h4 class="text-lg font-semibold">Estados (Teclas 1-4)</h4>
                </div>
                <p class="text-sm text-gray-400 mb-3">Prima 1-4 com o token selecionado para mudar a sua aparência.</p>
                
                <!-- Grelha de Estados (4 colunas) -->
                <div class="grid grid-cols-4 gap-2">
                    <!-- Estado 1 (Preview) -->
                    <div class="text-center">
                        <div id="state-slot-1" class="state-slot preview-only" title="Estado 1 (Original)"></div>
                        <label class="block text-xs font-medium text-gray-400 mt-1">Tecla 1</label>
                    </div>
                    
                    <!-- Estado 2 (Upload) -->
                    <div class="text-center">
                        <div class="state-slot relative">
                            <input type="file" id="token-state-2-file" class="hidden state-file-input" data-state="2" accept="image/*">
                            <label id="token-state-2-label" for="token-state-2-file" class="state-slot-label" title="Carregar Estado 2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                </svg>
                            </label>
                            <button id="token-state-2-clear" class="state-clear-btn-visual" data-state="2" title="Limpar Estado 2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <label class="block text-xs font-medium text-gray-400 mt-1">Tecla 2</label>
                    </div>

                    <!-- Estado 3 (Upload) -->
                    <div class="text-center">
                        <div class="state-slot relative">
                            <input type="file" id="token-state-3-file" class="hidden state-file-input" data-state="3" accept="image/*">
                            <label id="token-state-3-label" for="token-state-3-file" class="state-slot-label" title="Carregar Estado 3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                </svg>
                            </label>
                            <button id="token-state-3-clear" class="state-clear-btn-visual" data-state="3" title="Limpar Estado 3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <label class="block text-xs font-medium text-gray-400 mt-1">Tecla 3</label>
                    </div>

                    <!-- Estado 4 (Upload) -->
                    <div class="text-center">
                        <div class="state-slot relative">
                            <input type="file" id="token-state-4-file" class="hidden state-file-input" data-state="4" accept="image/*">
                            <label id="token-state-4-label" for="token-state-4-file" class="state-slot-label" title="Carregar Estado 4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                                </svg>
                            </label>
                            <button id="token-state-4-clear" class="state-clear-btn-visual" data-state="4" title="Limpar Estado 4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <label class="block text-xs font-medium text-gray-400 mt-1">Tecla 4</label>
                    </div>
                </div>
            </div>

            <!-- Secção de Animação -->
            <div class="mb-6 p-3 bg-gray-900/50 rounded-lg">
                <div class="flex items-center gap-2 text-gray-300 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m0 16.5V12M12 12l-1.5 1.5M12 12l1.5 1.5M12 12l-1.5-1.5M12 12l1.5-1.5M3 12h2.25M18.75 12H21M7.5 7.5l1.5 1.5M15 15l1.5 1.5" />
                    </svg>
                    <label for="animation-url-input" class="block text-sm font-medium">Animação/Efeito (URL)</label>
                </div>
                <div class="flex items-center gap-2 mt-1">
                    <input type="text" id="animation-url-input" placeholder="Ex: https://exemplo.com/fogo.gif" class="flex-grow block w-full rounded-md shadow-sm bg-gray-700 border-gray-600 text-white p-2">
                    <button id="clear-animation-btn" class="text-gray-400 hover:text-red-500 rounded p-1" title="Limpar Animação">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Secção de Aura -->
            <div class="mb-6 p-3 bg-gray-900/50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-6.364-.386l1.591-1.591M3 12H.75m.386-6.364l1.591 1.591M12 12a2.25 2.25 0 01-2.25-2.25 2.25 2.25 0 012.25-2.25 2.25 2.25 0 012.25 2.25 2.25 2.25 0 01-2.25 2.25z" />
                        </svg>
                        <h4 class="text-lg font-semibold">Aura (Externa)</h4>
                    </div>
                    <!-- Toggle Switch -->
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="token-aura-toggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                </div>
                <div class="mt-3 flex items-center gap-4">
                    <label for="token-aura-color" class="text-sm text-gray-400">Cor:</label>
                    <input type="color" id="token-aura-color" value="#ffffff" class="bg-gray-700 border-none rounded cursor-pointer">
                </div>
                <div class="mt-3">
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Intensidade (Blur)</span>
                        <span id="token-aura-size-label">10px</span>
                    </div>
                    <input type="range" id="token-aura-size" min="0" max="40" value="10" class="w-full mt-1">
                </div>
            </div>
            
            <!-- Secção de Luz Interna -->
            <div class="mb-6 p-3 bg-gray-900/50 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3 0a7.5 7.5 0 10-3 0M12 12.75V3" />
                        </svg>
                        <h4 class="text-lg font-semibold">Luz Interna</h4>
                    </div>
                    <!-- Toggle Switch -->
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="token-light-toggle" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                </div>
                <div class="mt-3 flex items-center gap-4">
                    <label for="token-light-color" class="text-sm text-gray-400">Cor:</label>
                    <input type="color" id="token-light-color" value="#ffffff" class="bg-gray-700 border-none rounded cursor-pointer">
                </div>
                <div class="mt-3">
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Intensidade (Blur)</span>
                        <span id="token-light-blur-label">15px</span>
                    </div>
                    <input type="range" id="token-light-blur" min="0" max="50" value="15" class="w-full mt-1">
                </div>
                <div class="mt-3">
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Distância</span>
                        <span id="token-light-distance-label">10px</span>
                    </div>
                    <input type="range" id="token-light-distance" min="0" max="50" value="10" class="w-full mt-1">
                </div>
                <div class="mt-3">
                    <div class="flex justify-between text-sm text-gray-400">
                        <span>Ângulo</span>
                        <span id="token-light-angle-label">0°</span>
                    </div>
                    <input type="range" id="token-light-angle" min="0" max="360" value="0" class="w-full mt-1">
                </div>
            </div>

            <!-- Secção de Efeito de Movimento -->
            <div class="mb-6 p-3 bg-gray-900/50 rounded-lg">
                <div class="flex items-center gap-2 text-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75v4.5m0-4.5h-4.5m4.5 0L15 9M20.25 20.25v-4.5m0 4.5h-4.5m4.5 0L15 15" />
                    </svg>
                    <h4 class="text-lg font-semibold">Efeito de Movimento</h4>
                </div>
                <select id="token-movement-select" class="mt-2 block w-full rounded-md shadow-sm bg-gray-700 border-gray-600 text-white p-2">
                    <option value="none">Nenhum</option>
                    <option value="pulse-normal">Pulsar</option>
                    <option value="pulse-agitated">Pulsar Agitado</option>
                    <option value="breathing-normal">Respiração Normal</option>
                    <option value="breathing-agitated">Respiração Agitada</option>
                    <option value="shake-sm">Tremer (Pequeno)</option>
                    <option value="shake-md">Tremer (Médio)</option>
                    <option value="shake-lg">Tremer (Grande)</option>
                </select>
            </div>
            
            <!-- Ações no Fundo do Painel -->
            <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-700">
                <!-- Botão Remover Token -->
                <button id="delete-token-btn" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Remover
                </button>
                
                <!-- Botão Guardar no Inventário -->
                <button id="save-to-inventory-btn" class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg" title="Guardar no Inventário">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                </button>
                
                <!-- Botão de Salvar -->
                <button id="save-token-btn" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <!-- Painel de Configurações de Luz (Lateral Direita) -->
    <div id="light-config-panel" class="fixed top-0 right-0 h-screen w-80 bg-gray-900/80 backdrop-blur-md border-l border-white/20 text-white shadow-lg z-[1900] transform translate-x-full transition-transform duration-300 overflow-y-auto hide-on-focus">
        <div class="p-6">
            <!-- Cabeçalho -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Propriedades da Luz</h2>
                <button id="close-light-panel-btn" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Controles -->
            <div class="mb-4">
                <label for="light-color-input" class="block text-sm font-medium text-gray-300 mb-2">Cor da Luz:</label>
                <input type="color" id="light-color-input" value="#ffffff" class="w-full h-10 bg-gray-700 border-none rounded cursor-pointer">
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-400">
                    <span>Tamanho (Raio)</span>
                    <span id="light-size-label">150px</span>
                </div>
                <input type="range" id="light-size-slider" min="50" max="1000" value="150" class="w-full mt-1">
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-gray-400">
                    <span>Intensidade (Blur)</span>
                    <span id="light-blur-label">75px</span>
                </div>
                <input type="range" id="light-blur-slider" min="20" max="300" value="75" class="w-full mt-1">
            </div>
            
            <!-- Efeito de Animação de Luz -->
            <div class="mb-4">
                <label for="light-effect-select" class="block text-sm font-medium text-gray-300 mb-2">Efeito de Animação:</label>
                <select id="light-effect-select" class="block w-full rounded-md shadow-sm bg-gray-700 border-gray-600 text-white p-2">
                    <option value="none">Nenhum</option>
                    <option value="pulse-suave">Pulsar Suave</option>
                    <option value="flicker-vela">Flicker (Vela)</option>
                    <option value="fogueira">Fogueira</option>
                </select>
            </div>

            <!-- Ações -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <button id="delete-light-btn" class="flex items-center gap-2 w-full justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Remover Luz
                </button>
            </div>
        </div>
    </div>


    <!-- Painel de Rolagem de Dados (Canto Inferior Direito) -->
    <div id="dice-roller-panel" class="hidden fixed bottom-4 right-4 z-110 p-4 bg-gray-800 bg-opacity-70 rounded-lg shadow-lg text-white w-[300px] hide-on-focus transition-opacity duration-300">
        <h4 class="font-bold mb-2">Rolador de Dados</h4>
        <div class="flex flex-wrap gap-2 mb-2">
            <button class="dice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded" data-sides="4">d4</button>
            <button class="dice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded" data-sides="6">d6</button>
            <button class="dice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded" data-sides="8">d8</button>
            <button class="dice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded" data-sides="10">d10</button>
            <button class="dice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded" data-sides="12">d12</button>
            <button class="dice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded" data-sides="20">d20</button>
            <button class="dice-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded" data-sides="100">d100</button>
        </div>
        <div id="dice-log" class="text-sm">
            <!-- As rolagens aparecerão aqui -->
        </div>
    </div>
    
    <!-- Painel de Inventário de Objetos (Inferior) -->
    <div id="object-inventory-panel" class="fixed bottom-0 left-0 w-full p-4 shadow-lg text-white bg-gray-900/80 backdrop-blur-md transform translate-y-full transition-transform duration-300 z-90 flex flex-col gap-4 hide-on-focus" style="max-height: 40vh;">
        <div class="flex justify-between items-center flex-shrink-0">
            <h4 class="font-bold text-lg">Inventário</h4>
            <div class="flex gap-2">
                <input type="file" id="import-inventory-input" class="hidden" accept=".json">
                <label for="import-inventory-input" class="text-sm bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded cursor-pointer">Importar</label>
                <button id="export-inventory-btn" class="text-sm bg-green-600 hover:bg-green-700 px-3 py-1 rounded">Exportar</button>
                <button id="close-inventory-btn" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="inventory-grid" class="flex-grow bg-gray-900/50 rounded-lg overflow-y-auto">
            <!-- Objetos guardados aparecerão aqui -->
        </div>
    </div>
    
    <!-- Menu de Contexto Personalizado -->
    <div id="custom-context-menu" class="hidden">
        <button id="ctx-add-token">Adicionar Token</button>
        <button id="ctx-load-map">Carregar Mapa</button>
        <button id="ctx-toggle-inventory">Inventário de Objetos</button>
        <button id="ctx-toggle-lights">Adicionar Luz</button>
        <button id="ctx-toggle-dice">Rolar Dados</button>
        <button id="ctx-toggle-cover">Esconder/Mostrar Mapa</button>
    </div>

    <!-- Versão do Build -->
    <div class="fixed bottom-4 right-4 text-white opacity-30 z-[4900] pointer-events-none hide-on-focus transition-opacity duration-300 font-mono text-sm">[ VER: 0.1.8 ]</div>

    <!-- Painel de Atalhos -->
    <div id="shortcuts-modal" class="hidden p-6 hide-on-focus z-[4500]">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Atalhos de Teclado</h3>
            <button id="close-shortcuts-btn" class="text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <ul class="space-y-3">
            <li class="flex justify-between items-center">
                <span>Esconder/Mostrar UI (Modo Foco)</span>
                <kbd>F</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Guardar Cena</span>
                <kbd>G</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Abrir/Fechar Rolador de Dados</span>
                <kbd>D</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Abrir/Fechar Inventário</span>
                <kbd>I</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Esconder/Mostrar Mapa</span>
                <kbd>E</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Modo Adicionar Luz</span>
                <kbd>L</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Abrir/Fechar Ajuda</span>
                <kbd>H</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Mudar Estado do Token (Selecionado)</span>
                <kbd>1</kbd> - <kbd>4</kbd>
            </li>
            <li class="flex justify-between items-center">
                <span>Deletar Item (Selecionado)</span>
                <kbd>Del</kbd>
            </li>
        </ul>
    </div>


    <script>
        // --- Seletores Globais de Elementos ---
        const board = document.getElementById('board');
        const canvasContainer = document.getElementById('canvas-container');
        const notificationContainer = document.getElementById('notification-container');
        const ludusLogo = document.getElementById('ludus-logo');
        
        // Painel Principal (Esquerda)
        const uiPanel = document.getElementById('modern-panel');
        const mapInput = document.getElementById('mapInput');
        const tokenInput = document.getElementById('tokenInput');
        const saveStateBtn = document.getElementById('save-state-btn');
        const loadStateInput = document.getElementById('load-state-input');
        const shortcutsToggleBtn = document.getElementById('shortcuts-toggle-btn');
        const lightToolBtn = document.getElementById('light-tool-btn');
        
        // Painel de Controlo de Token (Flutuante)
        const scalerUI = document.getElementById('scaler-ui');
        const configTokenBtn = document.getElementById('config-token-btn');
        const flipHBtn = document.getElementById('flip-h-btn');
        const flipVBtn = document.getElementById('flip-v-btn');
        const quickDeleteBtn = document.getElementById('quick-delete-btn');

        // Painel de Configuração de Token (Lateral Direita)
        const tokenConfigPanel = document.getElementById('token-config-panel');
        const closePanelBtn = document.getElementById('close-panel-btn');
        const tokenNameInput = document.getElementById('token-name-input');
        const animationUrlInput = document.getElementById('animation-url-input');
        const clearAnimationBtn = document.getElementById('clear-animation-btn');
        const saveTokenBtn = document.getElementById('save-token-btn');
        const deleteTokenBtn = document.getElementById('delete-token-btn');
        const saveToInventoryBtn = document.getElementById('save-to-inventory-btn');

        // Efeitos de Token (Movimento)
        const tokenMovementSelect = document.getElementById('token-movement-select');
        
        // Efeitos de Token (Aura)
        const tokenAuraToggle = document.getElementById('token-aura-toggle');
        const tokenAuraColor = document.getElementById('token-aura-color');
        const tokenAuraSize = document.getElementById('token-aura-size');
        const tokenAuraSizeLabel = document.getElementById('token-aura-size-label');

        // Efeitos de Token (Luz Interna)
        const tokenLightToggle = document.getElementById('token-light-toggle');
        const tokenLightColor = document.getElementById('token-light-color');
        const tokenLightBlur = document.getElementById('token-light-blur');
        const tokenLightDistance = document.getElementById('token-light-distance');
        const tokenLightAngle = document.getElementById('token-light-angle');
        const tokenLightBlurLabel = document.getElementById('token-light-blur-label');
        const tokenLightDistanceLabel = document.getElementById('token-light-distance-label');
        const tokenLightAngleLabel = document.getElementById('token-light-angle-label');

        // Painel de Dados
        const diceRollPanel = document.getElementById('dice-roller-panel');
        const diceToggleBtn = document.getElementById('dice-toggle-btn');
        const diceLog = document.getElementById('dice-log');

        // Inventário
        const inventoryPanel = document.getElementById('object-inventory-panel');
        const inventoryToggleBtn = document.getElementById('inventory-toggle-btn');
        const closeInventoryBtn = document.getElementById('close-inventory-btn');
        const inventoryGrid = document.getElementById('inventory-grid');
        const exportInventoryBtn = document.getElementById('export-inventory-btn');
        const importInventoryInput = document.getElementById('import-inventory-input');

        // Camada de Esconder Mapa
        const mapCoverCanvas = document.getElementById('map-cover-canvas');
        const mapCoverCtx = mapCoverCanvas.getContext('2d');
        const mapCoverToggleBtn = document.getElementById('map-cover-toggle-btn');
        
        // Menu de Contexto
        const contextMenu = document.getElementById('custom-context-menu');
        
        // Caixa de Transformação
        const transformBox = document.getElementById('transform-box');

        // Painel de Atalhos
        const shortcutsModal = document.getElementById('shortcuts-modal');
        const closeShortcutsBtn = document.getElementById('close-shortcuts-btn');
        
        // Luzes Dinâmicas
        const lightContainer = document.getElementById('dynamic-light-container');
        const lightConfigPanel = document.getElementById('light-config-panel');
        const closeLightPanelBtn = document.getElementById('close-light-panel-btn');
        const lightColorInput = document.getElementById('light-color-input');
        const lightSizeSlider = document.getElementById('light-size-slider');
        const lightBlurSlider = document.getElementById('light-blur-slider');
        const lightSizeLabel = document.getElementById('light-size-label');
        const lightBlurLabel = document.getElementById('light-blur-label');
        const lightEffectSelect = document.getElementById('light-effect-select');
        const deleteLightBtn = document.getElementById('delete-light-btn');


        // --- Estado Global ---
        let scale = 1;
        let originX = 0;
        let originY = 0;
        let isPanning = false;
        let selectedToken = null; 
        let selectedLight = null;
        let objectInventory = []; // Armazena os objetos guardados
        let isLightMode = false;
        
        let isTransforming = false;
        let transformAction = '';
        let transformPivot = { x: 0, y: 0 };
        let initialTokenState = {};
        let initialMousePos = { x: 0, y: 0 };
        
        let currentModalState = {}; // Armazena temporariamente os estados do modal

        
        // --- Funções Auxiliares de Base (Definidas Primeiro) ---

        function getEventCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }
        
        function showNotification(message, type = "success") {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            notificationContainer.appendChild(notif);
            
            // Remove a notificação após a animação
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }
        
        function updateScalerUIPosition() {
            if (!selectedToken || !scalerUI) return;
            
            // Ajusta a posição da UI flutuante
            const transformBoxRect = transformBox.getBoundingClientRect();
            if (transformBoxRect.top) {
                 scalerUI.style.left = `${transformBoxRect.right + 10}px`; // 10px à direita
                 scalerUI.style.top = `${transformBoxRect.top + transformBoxRect.height / 2 - scalerUI.offsetHeight / 2}px`; // Centralizado verticalmente
            } else {
                const tokenRect = selectedToken.getBoundingClientRect();
                 scalerUI.style.left = `${tokenRect.right + 10}px`; 
                 scalerUI.style.top = `${tokenRect.top + tokenRect.height / 2 - scalerUI.offsetHeight / 2}px`;
            }
        }
        
        function applyTokenTransform(token) {
            if (!token) return;
            // Aplica às 3 camadas internas
            const layers = token.querySelectorAll('.token-image-layer, .token-light-overlay, .token-overlay');
            const transform = `scale(${token.dataset.scaleX || 1}, ${token.dataset.scaleY || 1})`;
            layers.forEach(layer => {
                layer.style.transform = transform;
            });
        }
        
        
        // --- Lógica da Caixa de Transformação ---
        
        function showTransformBox(token) {
            if (!token || document.body.classList.contains('ui-hidden')) {
                hideTransformBox();
                return;
            }
            // Posiciona a caixa sobre o token
            transformBox.style.width = token.style.width;
            transformBox.style.height = token.style.height;
            transformBox.style.top = token.style.top;
            transformBox.style.left = token.style.left;
            transformBox.style.transform = `rotate(${token.dataset.rotateZ || 0}deg)`;
            transformBox.style.display = 'block';
        }
        
        function hideTransformBox() {
            if (transformBox) {
                transformBox.style.display = 'none';
            }
        }

        function startTransform(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!selectedToken) return;

            isTransforming = true;
            transformAction = e.target.dataset.action;
            
            const token = selectedToken;
            const tokenRect = token.getBoundingClientRect(); // Posição na tela
            
            // Pivô (centro do token na tela)
            transformPivot.x = tokenRect.left + tokenRect.width / 2;
            transformPivot.y = tokenRect.top + tokenRect.height / 2;

            initialMousePos = getEventCoords(e);
            
            // Guarda o estado inicial
            initialTokenState = {
                scale: parseFloat(token.dataset.scale || 1),
                rotateZ: parseFloat(token.dataset.rotateZ || 0),
                width: parseFloat(token.style.width),
                height: parseFloat(token.style.height),
                top: parseFloat(token.style.top),
                left: parseFloat(token.style.left),
                baseWidth: parseFloat(token.dataset.baseWidth),
                baseHeight: parseFloat(token.dataset.baseHeight),
            };

            if (transformAction === 'scale') {
                // Distância inicial do pivô ao rato
                initialTokenState.mouseDist = Math.hypot(
                    initialMousePos.x - transformPivot.x,
                    initialMousePos.y - transformPivot.y
                );
                document.addEventListener('mousemove', doScale);
                document.addEventListener('mouseup', endTransform);
                document.addEventListener('touchmove', doScale, { passive: false });
                document.addEventListener('touchend', endTransform);
                
            } else if (transformAction === 'rotate') {
                // Ângulo inicial do pivô ao rato
                initialTokenState.mouseAngle = Math.atan2(
                    initialMousePos.y - transformPivot.y,
                    initialMousePos.x - transformPivot.x
                );
                document.addEventListener('mousemove', doRotate);
                document.addEventListener('mouseup', endTransform);
                document.addEventListener('touchmove', doRotate, { passive: false });
                document.addEventListener('touchend', endTransform);
            }
        }
        
        function doScale(e) {
            if (!isTransforming || !selectedToken) return;
            e.preventDefault();

            const coords = getEventCoords(e);
            const newMouseDist = Math.hypot(
                coords.x - transformPivot.x,
                coords.y - transformPivot.y
            );
            
            // Evita divisão por zero e saltos
            if (initialTokenState.mouseDist < 1) return; 

            const scaleRatio = newMouseDist / initialTokenState.mouseDist;
            let newScale = initialTokenState.scale * scaleRatio;
            newScale = Math.max(0.1, Math.min(newScale, 10)); // Limita

            const token = selectedToken;
            token.dataset.scale = newScale;

            const newWidth = initialTokenState.baseWidth * newScale;
            const newHeight = initialTokenState.baseHeight * newScale;
            token.style.width = `${newWidth}px`;
            token.style.height = `${newHeight}px`;

            // Reposiciona para manter o centro
            token.style.left = `${initialTokenState.left - (newWidth - initialTokenState.width) / 2}px`;
            token.style.top = `${initialTokenState.top - (newHeight - initialTokenState.height) / 2}px`;
            
            // Atualiza a caixa de transformação e a UI flutuante
            showTransformBox(token);
            updateScalerUIPosition();
        }

        function doRotate(e) {
            if (!isTransforming || !selectedToken) return;
            e.preventDefault();

            const coords = getEventCoords(e);
            const currentMouseAngle = Math.atan2(
                coords.y - transformPivot.y,
                coords.x - transformPivot.x
            );
            
            const deltaAngle = currentMouseAngle - initialTokenState.mouseAngle;
            const newRotateZ = initialTokenState.rotateZ + (deltaAngle * 180 / Math.PI);
            
            const token = selectedToken;
            token.dataset.rotateZ = newRotateZ.toFixed(2);
            
            // Aplica rotação ao token (div principal) e à caixa
            const transform = `rotate(${newRotateZ.toFixed(2)}deg)`;
            token.style.transform = transform; // Roda o token
            transformBox.style.transform = transform; // Roda a caixa
            
            // Atualiza a UI flutuante
            updateScalerUIPosition();
        }
        
        function endTransform(e) {
            isTransforming = false;
            document.removeEventListener('mousemove', doScale);
            document.removeEventListener('mouseup', endTransform);
            document.removeEventListener('touchmove', doScale);
            document.removeEventListener('touchend', endTransform);
            
            document.removeEventListener('mousemove', doRotate);
            document.removeEventListener('mouseup', endTransform);
            document.removeEventListener('touchmove', doRotate);
            document.removeEventListener('touchend', endTransform);
        }


        // --- Inicialização ---
        // Evita que painéis de UI (dados, botões) ativem o pan/zoom do mapa
        [uiPanel, scalerUI, tokenConfigPanel, lightConfigPanel, diceRollPanel, inventoryPanel, contextMenu, shortcutsModal, transformBox].forEach(panel => {
            if (panel) {
                panel.addEventListener('wheel', (e) => e.stopPropagation());
                panel.addEventListener('mousedown', (e) => e.stopPropagation());
            }
        });
        
        // Listener para a caixa de transformação
        transformBox.addEventListener('mousedown', startTransform);


        // --- Lógica de Mapa e Token ---
        mapInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const mapURL = URL.createObjectURL(file);
                
                const img = new Image();
                img.onload = () => {
                    canvasContainer.style.width = `${img.width}px`;
                    canvasContainer.style.height = `${img.height}px`;
                    canvasContainer.style.backgroundImage = `url(${mapURL})`;
                    canvasContainer.style.backgroundSize = 'cover';
                    
                    // Ajusta a camada ao novo mapa
                    resizeAndResetMapCover(img.width, img.height);
                };
                img.src = mapURL;
            }
            e.target.files[0] = null;
        });

        tokenInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (readEvent) => {
                    createToken(readEvent.target.result, null, true); // Passa como Data URL
                };
                reader.readAsDataURL(file);
            }
            e.target.value = null; // Limpa para permitir carregar de novo
        });

        function createToken(url, tokenData = null, isDataURL = false) {
            const token = document.createElement('div');
            token.className = 'token';
            
            // Cria camadas internas
            const imageLayer = document.createElement('div');
            imageLayer.className = 'token-image-layer';
            token.appendChild(imageLayer);

            const lightOverlay = document.createElement('div');
            lightOverlay.className = 'token-light-overlay';
            token.appendChild(lightOverlay);

            let imageUrlCss = (isDataURL || !url.startsWith('url(')) ? `url(${url})` : url;

            if (tokenData) {
                // Se está a carregar, aplica dados guardados
                const savedImgUrl = tokenData.dataset.state1 || tokenData.style.backgroundImage;
                imageLayer.style.backgroundImage = savedImgUrl;
                imageLayer.style.maskImage = savedImgUrl;
                lightOverlay.style.maskImage = savedImgUrl;

                token.dataset.state1 = savedImgUrl;
                token.dataset.name = tokenData.dataset.name || "Token";
                token.dataset.scale = tokenData.dataset.scale || 1;
                
                token.style.top = tokenData.style.top;
                token.style.left = tokenData.style.left;
                token.style.width = tokenData.style.width;
                token.style.height = tokenData.style.height;

                // Calcula baseWidth/Height (importante se carregar de inventário)
                const scale = parseFloat(token.dataset.scale);
                token.dataset.baseWidth = parseFloat(token.style.width) / scale;
                token.dataset.baseHeight = parseFloat(token.style.height) / scale;

                // Carrega outros estados (2-4)
                for (let i = 2; i <= 4; i++) {
                    token.dataset['state' + i] = tokenData.dataset['state' + i] || '';
                }
                
                // Carrega Efeitos (Aura, Movimento, Luz)
                token.dataset.movement = tokenData.dataset.movement || 'none';
                token.dataset.auraActive = tokenData.dataset.auraActive || 'false';
                token.dataset.auraColor = tokenData.dataset.auraColor || '#ffffff';
                token.dataset.auraSize = tokenData.dataset.auraSize || '10';
                
                token.dataset.lightActive = tokenData.dataset.lightActive || 'false';
                token.dataset.lightColor = tokenData.dataset.lightColor || '#ffffff';
                token.dataset.lightBlur = tokenData.dataset.lightBlur || '15';
                token.dataset.lightDistance = tokenData.dataset.lightDistance || '10';
                token.dataset.lightAngle = tokenData.dataset.lightAngle || '0';

                // Carrega Transformações
                token.dataset.scaleX = tokenData.dataset.scaleX || 1;
                token.dataset.scaleY = tokenData.dataset.scaleY || 1;
                token.dataset.rotateZ = tokenData.dataset.rotateZ || 0;

                applyMovementEffect(token, token.dataset.movement);
                applyTokenFilters(token); // Aplica aura
                applyInnerLightEffect(token, token.dataset.lightActive, token.dataset.lightColor, token.dataset.lightBlur, token.dataset.lightDistance, token.dataset.lightAngle);
                
                // Aplica transformações (Rotação e Flip)
                token.style.transform = `rotate(${token.dataset.rotateZ || 0}deg)`;
                applyTokenTransform(token); // Aplica o flip


                addTokenEventListeners(token);
                canvasContainer.appendChild(token);

            } else {
                // Se é um token novo
                imageLayer.style.backgroundImage = imageUrlCss;
                imageLayer.style.maskImage = imageUrlCss;
                lightOverlay.style.maskImage = imageUrlCss;

                token.dataset.state1 = imageUrlCss;
                token.dataset.name = "Novo Token";
                token.dataset.scale = 1;
                
                // Inicializa Transformações
                token.dataset.scaleX = 1;
                token.dataset.scaleY = 1;
                token.dataset.rotateZ = 0;

                const img = new Image();
                img.onload = () => {
                    token.dataset.baseWidth = img.width;
                    token.dataset.baseHeight = img.height;
                    
                    token.style.width = `${img.width}px`;
                    token.style.height = `${img.height}px`;

                    // Posição inicial (canto superior esquerdo do ecrã)
                    const worldX = (20 - originX) / scale;
                    const worldY = (20 - originY) / scale;
                    
                    token.style.top = `${worldY}px`;
                    token.style.left = `${worldX}px`;

                    addTokenEventListeners(token);
                    canvasContainer.appendChild(token);
                    
                    applyTokenFilters(token); // Aplica filtros (necessário para sombras dinâmicas)
                };
                img.src = url; // url é Data URL aqui
            }
        }
        
        function addTokenEventListeners(token) {
            token.addEventListener('mousedown', startDrag);
            token.addEventListener('touchstart', startDrag, { passive: false });

            token.addEventListener('click', (e) => {
                e.stopPropagation(); // Impede que o clique feche o painel
                selectToken(token);
            });
            
            // Camada de Luz já está no createToken
        }

        // --- Lógica de Arrastar ---
        let activeToken = null;
        let lastTouchCoords = null; 

        function startDrag(e) {
            // Não arrasta se estiver a iniciar uma transformação
            if (e.target.closest('#transform-box')) return;
            
            // Ignora se for botão do meio
            if (e.button === 1) return;
            
            if (e.type === 'touchstart') {
                e.preventDefault();
                lastTouchCoords = getEventCoords(e); // Guarda a posição inicial do toque
            }
            else e.preventDefault();
            
            activeToken = e.target.closest('.token');
            if (!activeToken) return;

            activeToken.classList.add('dragging');
            selectToken(activeToken);

            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', dragMove, { passive: false });
            document.addEventListener('touchend', endDrag);
        }

        function dragMove(e) {
            if (!activeToken) return;

            let movementX = 0;
            let movementY = 0;

            if (e.type === 'touchmove') {
                e.preventDefault();
                const coords = getEventCoords(e);
                if (lastTouchCoords) {
                    movementX = coords.x - lastTouchCoords.x;
                    movementY = coords.y - lastTouchCoords.y;
                }
                lastTouchCoords = coords; // Atualiza a última posição do toque
            } else {
                // 'mousemove'
                movementX = e.movementX;
                movementY = e.movementY;
            }
            
            // Converte o movimento da tela (delta) para o movimento do mundo (delta)
            const worldDeltaX = movementX / scale;
            const worldDeltaY = movementY / scale;

            const currentLeft = parseFloat(activeToken.style.left);
            const currentTop = parseFloat(activeToken.style.top);

            activeToken.style.left = `${currentLeft + worldDeltaX}px`;
            activeToken.style.top = `${currentTop + worldDeltaY}px`;
            
            applyTokenFilters(activeToken); // Atualiza filtros (sombra)

            if (selectedToken === activeToken) {
                updateScalerUIPosition();
                showTransformBox(activeToken); // Atualiza a caixa
            }
        }

        function endDrag(e) {
            if (!activeToken) return;
            activeToken.classList.remove('dragging');
            activeToken = null;
            lastTouchCoords = null; // Limpa a última posição do toque
            
            document.removeEventListener('mousemove', dragMove);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', dragMove);
            document.removeEventListener('touchend', endDrag);
        }
        
        // --- Lógica de Controlo de Token (Flutuante) ---

        function selectToken(token) {
            if (isTransforming) return; // Não troca a seleção se estiver a escalar/rodar
            
            // Deseleciona luz
            deselectAllLights();
            
            if (selectedToken && selectedToken !== token) {
                selectedToken.classList.remove('selected');
            }
            selectedToken = token;
            selectedToken.classList.add('selected');
            
            // Mostra a UI de botões (config, flip, delete)
            if (!document.body.classList.contains('ui-hidden')) {
                scalerUI.classList.remove('hidden');
                updateScalerUIPosition();
            }
            
            // Mostra a caixa de transformação
            showTransformBox(token);
        }

        function deselectAll() {
            if (isTransforming) return; // Não deseleciona se estiver a transformar
            
            if (selectedToken) {
                selectedToken.classList.remove('selected');
            }
            selectedToken = null;
            scalerUI.classList.add('hidden');
            tokenConfigPanel.classList.add('translate-x-full'); 
            tokenConfigPanel.classList.remove('translate-x-0');
            
            // Esconde a caixa de transformação
            hideTransformBox();
            
            // Deseleciona luzes também
            deselectAllLights();
        }
        
        flipHBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (selectedToken) {
                selectedToken.dataset.scaleX = parseFloat(selectedToken.dataset.scaleX || 1) * -1;
                applyTokenTransform(selectedToken);
            }
        });
        
        flipVBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (selectedToken) {
                selectedToken.dataset.scaleY = parseFloat(selectedToken.dataset.scaleY || 1) * -1;
                applyTokenTransform(selectedToken);
            }
        });
        
        // Listener para o botão de deletar rápido
        quickDeleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (selectedToken) {
                selectedToken.remove();
                showNotification("Token removido", "error");
                deselectAll(); 
            }
        });
        
        scalerUI.addEventListener('mousedown', (e) => e.stopPropagation());

        // --- Lógica do Painel de Configuração de Token (Lateral Direita) ---
        configTokenBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (selectedToken) {
                openTokenConfigModal(selectedToken);
            }
        });

        closePanelBtn.addEventListener('click', () => { 
            tokenConfigPanel.classList.add('translate-x-full');
            tokenConfigPanel.classList.remove('translate-x-0');
        });

        saveTokenBtn.addEventListener('click', () => {
            if (selectedToken) {
                selectedToken.dataset.name = tokenNameInput.value; // Atualiza o nome
                
                const url = animationUrlInput.value.trim();
                applyTokenAnimation(selectedToken, url); // Aplica animação

                // Guarda os novos estados (2-4) do estado temporário
                for (let i = 2; i <= 4; i++) {
                    const stateKey = 'state' + i;
                    selectedToken.dataset[stateKey] = currentModalState[stateKey] || '';
                }

                // Guarda Efeitos (Movimento)
                const movementValue = tokenMovementSelect.value;
                selectedToken.dataset.movement = movementValue;
                applyMovementEffect(selectedToken, movementValue);
                
                // Guarda Efeitos (Aura)
                const auraActive = tokenAuraToggle.checked.toString();
                const auraColor = tokenAuraColor.value;
                const auraSize = tokenAuraSize.value;
                selectedToken.dataset.auraActive = auraActive;
                selectedToken.dataset.auraColor = auraColor;
                selectedToken.dataset.auraSize = auraSize;
                
                // Guarda Efeitos (Luz Interna)
                const lightActive = tokenLightToggle.checked.toString();
                const lightColor = tokenLightColor.value;
                const lightBlur = tokenLightBlur.value;
                const lightDistance = tokenLightDistance.value;
                const lightAngle = tokenLightAngle.value;
                selectedToken.dataset.lightActive = lightActive;
                selectedToken.dataset.lightColor = lightColor;
                selectedToken.dataset.lightBlur = lightBlur;
                selectedToken.dataset.lightDistance = lightDistance;
                selectedToken.dataset.lightAngle = lightAngle;
                applyInnerLightEffect(selectedToken, lightActive, lightColor, lightBlur, lightDistance, lightAngle);
                
                // Guarda Efeitos (Sombra) - REMOVIDO
                
                applyTokenFilters(selectedToken); // Atualiza filtros combinados
                
                showNotification("Token guardado!", "success");
            }
            tokenConfigPanel.classList.add('translate-x-full'); 
            tokenConfigPanel.classList.remove('translate-x-0');
        });
        
        clearAnimationBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            animationUrlInput.value = '';
            if (selectedToken) {
                applyTokenAnimation(selectedToken, '');
            }
        });

        deleteTokenBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (selectedToken) {
                selectedToken.remove();
                showNotification("Token removido", "error");
                deselectAll(); 
            }
        });

        function openTokenConfigModal(token) {
            // Preenche o modal com os dados do token selecionado
            tokenNameInput.value = token.dataset.name || '';
            animationUrlInput.value = token.dataset.animationUrl || '';

            // Reseta o estado temporário e preenche os campos de estado (2-4)
            currentModalState = {};
            document.getElementById('state-slot-1').style.backgroundImage = token.dataset.state1 || 'none';

            for (let i = 2; i <= 4; i++) {
                const stateKey = 'state' + i;
                const dataUrl = token.dataset[stateKey] || '';
                currentModalState[stateKey] = dataUrl; // Guarda no estado temporário
                
                const labelEl = document.getElementById(`token-state-${i}-label`);
                
                if (dataUrl) {
                    labelEl.style.backgroundImage = dataUrl;
                    labelEl.classList.add('has-image');
                } else {
                    labelEl.style.backgroundImage = 'none';
                    labelEl.classList.remove('has-image');
                }
                
                const fileInput = document.getElementById(`token-state-${i}-file`);
                fileInput.value = null; // Limpa o input de ficheiro
            }

            // Preenche Efeitos (Movimento, Aura, Luz)
            tokenMovementSelect.value = token.dataset.movement || 'none';
            tokenAuraToggle.checked = (token.dataset.auraActive === 'true');
            tokenAuraColor.value = token.dataset.auraColor || '#ffffff';
            tokenAuraSize.value = token.dataset.auraSize || '10';
            tokenAuraSizeLabel.textContent = `${tokenAuraSize.value}px`;
            
            tokenLightToggle.checked = (token.dataset.lightActive === 'true');
            tokenLightColor.value = token.dataset.lightColor || '#ffffff';
            tokenLightBlur.value = token.dataset.lightBlur || '15';
            tokenLightDistance.value = token.dataset.lightDistance || '10';
            tokenLightAngle.value = token.dataset.lightAngle || '0';
            tokenLightBlurLabel.textContent = `${tokenLightBlur.value}px`;
            tokenLightDistanceLabel.textContent = `${tokenLightDistance.value}px`;
            tokenLightAngleLabel.textContent = `${tokenLightAngle.value}°`;
            
            // Preenche Sombra (REMOVIDO)

            tokenConfigPanel.classList.remove('translate-x-full'); 
            tokenConfigPanel.classList.add('translate-x-0');
        }

        // --- Funções de Aplicação de Efeitos ---
        
        function applyTokenAnimation(token, url) {
            let overlay = token.querySelector('.token-overlay');
            if (url) {
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'token-overlay';
                    // Aplica transformações existentes ao novo overlay
                    applyTokenTransform(token);
                    token.appendChild(overlay);
                }
                overlay.style.backgroundImage = `url(${url})`;
                overlay.style.maskImage = token.querySelector('.token-image-layer').style.maskImage;
                token.dataset.animationUrl = url;
            } else {
                if (overlay) {
                    overlay.remove();
                }
                token.dataset.animationUrl = '';
            }
        }
        
        function applyMovementEffect(token, movementValue) {
            // Remove todas as classes de movimento primeiro
            token.classList.remove('shake-sm', 'shake-md', 'shake-lg', 'breathing-normal', 'breathing-agitated', 'pulse-normal', 'pulse-agitated');
            if (movementValue !== 'none') {
                token.classList.add(movementValue);
            }
        }
        
        // Combina Aura e Sombra Dinâmica
        function applyTokenFilters(token) {
            if (!token) return;

            let filters = [];
            
            // Aura (Externa)
            if (token.dataset.auraActive === 'true') {
                const color = token.dataset.auraColor || '#ffffff';
                const size = token.dataset.auraSize || '10';
                const blurRadius = `${size}px`;
                filters.push(`drop-shadow(0 0 ${blurRadius} ${color})`);
                filters.push(`drop-shadow(0 0 ${parseFloat(blurRadius)/2}px ${color})`);
            }
            
            // Sombra (REMOVIDO)
            
            token.style.filter = filters.join(' ');
        }
        
        
        function applyInnerLightEffect(token, active, color, blur, distance, angle) {
            const overlay = token.querySelector('.token-light-overlay');
            if (!overlay) return; // Segurança

            if (active === 'true') {
                // 0° = topo, 90° = direita, 180° = baixo, 270° = esquerda
                const angleRad = (parseFloat(angle) - 90) * (Math.PI / 180);
                const offsetX = Math.round(Math.cos(angleRad) * parseFloat(distance));
                const offsetY = Math.round(Math.sin(angleRad) * parseFloat(distance));
                
                overlay.style.boxShadow = `inset ${offsetX}px ${offsetY}px ${blur}px ${color}`;
            } else {
                overlay.style.boxShadow = 'none'; // Remove o filtro
            }
        }

        // --- Listeners de Efeitos (Atualização em Tempo Real) ---

        tokenAuraToggle.addEventListener('input', (e) => {
             if(selectedToken) {
                 selectedToken.dataset.auraActive = e.target.checked.toString();
                 applyTokenFilters(selectedToken);
             }
        });
        tokenAuraColor.addEventListener('input', (e) => {
             if(selectedToken) {
                 selectedToken.dataset.auraColor = e.target.value;
                 applyTokenFilters(selectedToken);
             }
        });
        tokenAuraSize.addEventListener('input', (e) => {
             tokenAuraSizeLabel.textContent = `${e.target.value}px`;
             if(selectedToken) {
                 selectedToken.dataset.auraSize = e.target.value;
                 applyTokenFilters(selectedToken);
             }
        });

        tokenMovementSelect.addEventListener('input', (e) => {
            if (selectedToken) applyMovementEffect(selectedToken, e.target.value);
        });
        
        function updateInnerLight() {
            if (selectedToken) {
                applyInnerLightEffect(
                    selectedToken,
                    tokenLightToggle.checked.toString(),
                    tokenLightColor.value,
                    tokenLightBlur.value,
                    tokenLightDistance.value,
                    tokenLightAngle.value
                );
            }
        }
        tokenLightToggle.addEventListener('input', updateInnerLight);
        tokenLightColor.addEventListener('input', updateInnerLight);
        
        tokenLightBlur.addEventListener('input', (e) => {
            tokenLightBlurLabel.textContent = `${e.target.value}px`;
            updateInnerLight();
        });
        tokenLightDistance.addEventListener('input', (e) => {
            tokenLightDistanceLabel.textContent = `${e.target.value}px`;
            updateInnerLight();
        });
        tokenLightAngle.addEventListener('input', (e) => {
            tokenLightAngleLabel.textContent = `${e.target.value}°`;
            updateInnerLight();
        });
        
        // Listeners Sombra (REMOVIDO)

        // --- Listeners para Upload de Estados de Token ---
        document.querySelectorAll('.state-file-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const stateNum = e.target.dataset.state;
                const stateKey = 'state' + stateNum;
                const labelEl = document.getElementById(`token-state-${stateNum}-label`);

                if (!file) return;

                const reader = new FileReader();
                reader.onload = (readEvent) => {
                    const dataUrl = readEvent.target.result;
                    const dataUrlCss = "url(" + dataUrl + ")";
                    // Armazena a imagem como data URL no estado temporário
                    currentModalState[stateKey] = dataUrlCss;
                    labelEl.style.backgroundImage = dataUrlCss; // Mostra preview
                    labelEl.classList.add('has-image');
                };
                reader.readAsDataURL(file); // Converte imagem para Base64
            });
        });

        document.querySelectorAll('.state-clear-btn-visual').forEach(button => {
            button.addEventListener('click', (e) => {
                const btn = e.target.closest('.state-clear-btn-visual');
                const stateNum = btn.dataset.state;
                const stateKey = 'state' + stateNum;
                
                // Limpa o estado temporário
                currentModalState[stateKey] = '';
                
                // Reseta a UI
                const labelEl = document.getElementById(`token-state-${stateNum}-label`);
                labelEl.style.backgroundImage = 'none';
                labelEl.classList.remove('has-image');
                document.getElementById(`token-state-${stateNum}-file`).value = null;
            });
        });


        // --- Lógica de Pan (Arrastar Mapa) e Zoom ---
        board.addEventListener('click', (e) => {
            // Verifica se o clique foi diretamente no board ou no container
            if (e.target === board || e.target === canvasContainer) {
                
                // Se estiver no modo de luz, adiciona luz
                if (isLightMode && !document.body.classList.contains('ui-hidden')) {
                    const rect = canvasContainer.getBoundingClientRect();
                    const x = (e.clientX - rect.left - originX) / scale;
                    const y = (e.clientY - rect.top - originY) / scale;
                    createDynamicLight(x, y);
                } else {
                    // Se não, deseleciona tudo
                    deselectAll();
                }
                
            }
            contextMenu.style.display = 'none'; // Esconde menu de contexto
        });

        board.addEventListener('mousedown', (e) => {
            // Pan com botão do meio
            if (e.button === 1) {
                isPanning = true;
                board.classList.add('panning');
                e.preventDefault(); 
            }
            contextMenu.style.display = 'none'; // Esconde menu de contexto
        });
        
        // --- Lógica do Menu de Contexto ---
        board.addEventListener('contextmenu', (e) => {
            e.preventDefault(); // Impede o menu padrão
            
            // Se estiver sobre um token, não mostra o menu do mapa
            if (e.target.closest('.token') || e.target.closest('#transform-box') || e.target.closest('.dynamic-light')) {
                return;
            }

            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.display = 'block';
        });
        
        // Esconde o menu se clicar em qualquer outro sítio
        document.addEventListener('click', (e) => {
            if (contextMenu && !contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
            // Esconde o modal de atalhos se clicar fora
            if (shortcutsModal && !shortcutsModal.contains(e.target) && !shortcutsToggleBtn.contains(e.target)) {
                shortcutsModal.classList.add('hidden');
            }
        });
        
        // Ações do Menu de Contexto
        document.getElementById('ctx-add-token').addEventListener('click', () => {
            tokenInput.click(); // Simula clique no <input type="file">
            contextMenu.style.display = 'none';
        });
        document.getElementById('ctx-load-map').addEventListener('click', () => {
            mapInput.click(); // Simula clique no <input type="file">
            contextMenu.style.display = 'none';
        });
        document.getElementById('ctx-toggle-inventory').addEventListener('click', () => {
            inventoryToggleBtn.click(); // Simula clique no botão
            contextMenu.style.display = 'none';
        });
        document.getElementById('ctx-toggle-lights').addEventListener('click', () => {
            if (document.body.classList.contains('ui-hidden')) return; // Bloqueia no modo oculto
            lightToolBtn.click(); // Simula clique no botão
            contextMenu.style.display = 'none';
        });
        document.getElementById('ctx-toggle-dice').addEventListener('click', () => {
            diceToggleBtn.click(); // Simula clique no botão
            contextMenu.style.display = 'none';
        });
        document.getElementById('ctx-toggle-cover').addEventListener('click', () => {
            mapCoverToggleBtn.click(); // Simula clique no botão
            contextMenu.style.display = 'none';
        });
        // --- Fim da Lógica do Menu de Contexto ---


        document.addEventListener('mousemove', (e) => {
            if (isPanning) {
                originX += e.movementX;
                originY += e.movementY;
                updateCanvasTransform();
            } else if (isDragLight) {
                dragLight(e);
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (isPanning && e.button === 1) {
                isPanning = false;
                board.classList.remove('panning');
            }
            if (isDragLight) {
                endDragLight(e);
            }
        });
        
        board.addEventListener('wheel', (e) => {
            e.preventDefault();
            contextMenu.style.display = 'none'; // Esconde menu de contexto

            const boardRect = board.getBoundingClientRect();
            const mouseX = e.clientX - boardRect.left;
            const mouseY = e.clientY - boardRect.top;

            const worldX_before = (mouseX - originX) / scale;
            const worldY_before = (mouseY - originY) / scale;
            
            const zoomAmount = e.deltaY < 0 ? 1.1 : 0.9;
            const oldScale = scale;
            
            scale *= zoomAmount;

            if (scale < 0.1) scale = 0.1;
            if (scale > 5) scale = 5;

            if (scale === oldScale) return;

            originX = mouseX - worldX_before * scale;
            originY = mouseY - worldY_before * scale;

            updateCanvasTransform();
        });

        // --- Lógica de Guardar/Carregar Cena ---
        saveStateBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const allTokens = document.querySelectorAll('.token');
            const allLights = document.querySelectorAll('.dynamic-light');
            const state = {
                map: {
                    url: canvasContainer.style.backgroundImage,
                    width: canvasContainer.style.width,
                    height: canvasContainer.style.height
                },
                inventory: objectInventory, 
                tokens: [],
                lights: []
            };

            allTokens.forEach(token => {
                state.tokens.push({
                    style: {
                        top: token.style.top,
                        left: token.style.left,
                        width: token.style.width,
                        height: token.style.height
                    },
                    dataset: { ...token.dataset }
                });
            });
            
            allLights.forEach(light => {
                state.lights.push({
                    top: light.style.top,
                    left: light.style.left,
                    size: light.dataset.size,
                    blur: light.dataset.blur,
                    color: light.dataset.color,
                    effect: light.dataset.effect || 'none'
                });
            });

            // Cria e faz download do ficheiro JSON
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "rpg_mapa_cena.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showNotification("Cena guardada com sucesso!", "success");
        });

        loadStateInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const state = JSON.parse(event.target.result);
                    loadState(state);
                    showNotification("Cena carregada com sucesso!", "success");
                } catch (error) {
                    console.error("Erro ao carregar ficheiro de cena:", error);
                    showNotification("Erro: Ficheiro de cena inválido.", "error");
                }
            };
            reader.readAsText(file);
            loadStateInput.value = null; // Limpa para permitir carregar de novo
        });

        function loadState(state) {
            // Limpa o tabuleiro
            document.querySelectorAll('.token').forEach(t => t.remove());
            document.querySelectorAll('.dynamic-light').forEach(l => l.remove());
            deselectAll();
            
            // Carrega o Mapa
            canvasContainer.style.width = state.map.width;
            canvasContainer.style.height = state.map.height;
            canvasContainer.style.backgroundImage = state.map.url;

            // Recria a camada de cobertura
            resizeAndResetMapCover(
                state.map.width ? parseFloat(state.map.width) : 3000,
                state.map.height ? parseFloat(state.map.height) : 3000
            );
            
            // Carrega os Tokens
            if (state.tokens) {
                state.tokens.forEach(tokenData => {
                    const imgUrl = tokenData.dataset.state1 || tokenData.style.backgroundImage;
                    createToken(imgUrl, tokenData);
                });
            }
            
            // Carrega as Luzes
            if (state.lights) {
                state.lights.forEach(lightData => {
                    createDynamicLight(0, 0, lightData); // Posição será sobrescrita
                });
            }
            
            // Carrega o Inventário
            if (state.inventory) {
                objectInventory = state.inventory;
                renderInventory();
            }
            
            deselectAll(); 
        }

        // --- Lógica de Esconder Mapa ---
        mapCoverToggleBtn.addEventListener('click', () => {
            const isHiding = mapCoverCanvas.style.opacity === '0';

            if (isHiding) {
                // Esconde o mapa/tokens
                mapCoverCanvas.style.opacity = '1';
                // E também esconde o painel de dados e a UI de escala
                diceRollPanel.classList.add('hidden');
                deselectAll(); // Deseleciona tokens e luzes
            } else {
                // Mostra o mapa/tokens
                mapCoverCanvas.style.opacity = '0';
            }
        });

        function resizeAndResetMapCover(width, height) {
            mapCoverCanvas.width = width;
            mapCoverCanvas.height = height;
            mapCoverCtx.fillStyle = 'rgba(0, 0, 0, 0.85)';
            mapCoverCtx.fillRect(0, 0, width, height);
        }

        // --- Lógica do Rolador de Dados ---
        diceToggleBtn.addEventListener('click', () => {
            diceRollPanel.classList.toggle('hidden');
        });
        document.querySelectorAll('.dice-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const sides = parseInt(e.target.dataset.sides);
                const roll = Math.floor(Math.random() * sides) + 1;
                
                const logEntry = document.createElement('p');
                logEntry.innerHTML = `<span class="font-bold text-lg">${roll}</span> (d${sides})`;
                diceLog.prepend(logEntry); // Adiciona no topo
            });
        });

        
        // --- Lógica do Inventário de Objetos ---
        inventoryToggleBtn.addEventListener('click', () => {
            inventoryPanel.classList.toggle('translate-y-full');
            inventoryPanel.classList.toggle('translate-y-0');
        });
        closeInventoryBtn.addEventListener('click', () => {
            inventoryPanel.classList.add('translate-y-full');
            inventoryPanel.classList.remove('translate-y-0');
        });
        
        saveToInventoryBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!selectedToken) return;

            // 1. Guarda as configurações atuais (do painel) no token
            // Cópia manual da lógica de 'saveTokenBtn'
            selectedToken.dataset.name = tokenNameInput.value;
            const url = animationUrlInput.value.trim();
            applyTokenAnimation(selectedToken, url);
            for (let i = 2; i <= 4; i++) {
                selectedToken.dataset['state' + i] = currentModalState['state' + i] || '';
            }
            const movementValue = tokenMovementSelect.value;
            selectedToken.dataset.movement = movementValue;
            applyMovementEffect(selectedToken, movementValue);
            const auraActive = tokenAuraToggle.checked.toString();
            const auraColor = tokenAuraColor.value;
            const auraSize = tokenAuraSize.value;
            selectedToken.dataset.auraActive = auraActive;
            selectedToken.dataset.auraColor = auraColor;
            selectedToken.dataset.auraSize = auraSize;
            applyTokenFilters(selectedToken); // Aplica aura
            const lightActive = tokenLightToggle.checked.toString();
            const lightColor = tokenLightColor.value;
            const lightBlur = tokenLightBlur.value;
            const lightDistance = tokenLightDistance.value;
            const lightAngle = tokenLightAngle.value;
            selectedToken.dataset.lightActive = lightActive;
            selectedToken.dataset.lightColor = lightColor;
            selectedToken.dataset.lightBlur = lightBlur;
            selectedToken.dataset.lightDistance = lightDistance;
            selectedToken.dataset.lightAngle = lightAngle;
            applyInnerLightEffect(selectedToken, lightActive, lightColor, lightBlur, lightDistance, lightAngle);
            
            // 2. Fecha o painel
            tokenConfigPanel.classList.add('translate-x-full'); 
            tokenConfigPanel.classList.remove('translate-x-0');

            // 3. Cria o objeto de dados
            const tokenData = {
                style: {
                    top: '0px',
                    left: '0px',
                    width: `${selectedToken.dataset.baseWidth}px`,
                    height: `${selectedToken.dataset.baseHeight}px`
                },
                dataset: { ...selectedToken.dataset }
            };
            tokenData.dataset.scale = 1;
            
            // 4. Adiciona ao inventário
            objectInventory.push(tokenData);
            
            // 5. Atualiza a UI do inventário
            renderInventory();
            
            // 6. Mostra notificação
            showNotification("Token guardado no inventário!", "success");
        });

        function renderInventory() {
            inventoryGrid.innerHTML = ''; // Limpa a grelha

            objectInventory.forEach((itemData, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item';
                itemEl.draggable = true;
                
                const previewImg = itemData.dataset.state1 || itemData.style.backgroundImage;

                itemEl.innerHTML = `
                    <div class="preview" style="background-image: ${previewImg}"></div>
                    <span>${itemData.dataset.name || 'Objeto'}</span>
                `;
                
                // Botão de apagar
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'inventory-delete-btn';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    objectInventory.splice(index, 1); // Remove do array
                    renderInventory(); // Re-desenha
                };

                // Evento de arrastar
                itemEl.addEventListener('dragstart', (e) => {
                    // Guarda todos os dados do objeto
                    e.dataTransfer.setData("text/plain", JSON.stringify(itemData));
                    e.dataTransfer.effectAllowed = "copy";
                });
                
                itemEl.appendChild(deleteBtn);
                inventoryGrid.appendChild(itemEl);
            });
        }

        // Exportar Inventário
        exportInventoryBtn.addEventListener('click', () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(objectInventory, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "rpg_inventario.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        // Importar Inventário
        importInventoryInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const newInventory = JSON.parse(event.target.result);
                    if (Array.isArray(newInventory)) {
                        objectInventory = newInventory;
                        renderInventory();
                        showNotification("Inventário importado!", "success");
                    }
                } catch (error) {
                    console.error("Erro ao carregar ficheiro de inventário:", error);
                    showNotification("Ficheiro de inventário inválido", "error");
                }
            };
            reader.readAsText(file);
            importInventoryInput.value = null; // Limpa
        });

        // --- Drag-and-Drop do Inventário para o Mapa ---
        board.addEventListener('dragover', (e) => {
            e.preventDefault(); // Necessário para permitir o 'drop'
        });

        board.addEventListener('drop', (e) => {
            e.preventDefault();
            
            try {
                const objectData = JSON.parse(e.dataTransfer.getData("text/plain"));
                if (!objectData || !objectData.style) return;

                const boardRect = board.getBoundingClientRect();
                
                // Calcula a posição no "mundo"
                const worldX = (e.clientX - boardRect.left - originX) / scale;
                const worldY = (e.clientY - boardRect.top - originY) / scale;
                
                // Centraliza o token no cursor
                const tokenWidth = parseFloat(objectData.style.width);
                const tokenHeight = parseFloat(objectData.style.height);
                
                const finalX = worldX - (tokenWidth / 2);
                const finalY = worldY - (tokenHeight / 2);

                // Atualiza a posição no objeto
                objectData.style.left = `${finalX}px`;
                objectData.style.top = `${finalY}px`;

                // Cria o novo token
                const imgUrl = objectData.dataset.state1 || objectData.style.backgroundImage;
                createToken(imgUrl, objectData);

            } catch (err) {
                console.error("Erro ao largar objeto:", err);
            }
        });
        
        // --- Lógica das Luzes Dinâmicas ---
        
        lightToolBtn.addEventListener('click', () => {
            if (document.body.classList.contains('ui-hidden')) return; // Bloqueia no modo oculto
            isLightMode = !isLightMode;
            board.classList.toggle('light-mode', isLightMode);
            lightToolBtn.classList.toggle('active', isLightMode);
        });
        
        function createDynamicLight(x, y, data = null) {
            const light = document.createElement('div');
            light.className = 'dynamic-light';
            
            if (data) {
                // Carregando de um save
            } else {
                data = {
                    left: `${x}px`, 
                    top: `${y}px`, 
                    size: '150',
                    blur: '75',
                    color: '#ffffff',
                    effect: 'none'
                };
            }
            
            light.dataset.size = data.size;
            light.dataset.blur = data.blur;
            light.dataset.color = data.color;
            light.dataset.effect = data.effect;
            light.style.left = data.left;
            light.style.top = data.top;
            
            applyLightEffect(light);
            applyLightAnimation(light, data.effect);
            
            // Eventos de arrastar
            light.addEventListener('mousedown', startDragLight);
            light.addEventListener('touchstart', startDragLight, { passive: false });
            
            // Evento de selecionar
            light.addEventListener('click', (e) => {
                if (document.body.classList.contains('ui-hidden')) return; // Bloqueia no modo oculto
                e.stopPropagation();
                selectLight(light);
            });
            
            lightContainer.appendChild(light);
            return light;
        }

        function applyLightEffect(light) {
            const size = light.dataset.size;
            const blur = light.dataset.blur;
            const color = light.dataset.color;
            
            light.style.width = `${size}px`;
            light.style.height = `${size}px`;
            light.style.backgroundColor = color;
            light.style.boxShadow = `0 0 ${blur}px ${blur}px ${color}`;
            
            // Centraliza no cursor (ajuste de offset)
            const offset = parseFloat(size) / 2;
            light.style.transform = `translate(-${offset}px, -${offset}px)`;
        }
        
        function applyLightAnimation(light, effectValue) {
            light.classList.remove('pulse-suave', 'flicker-vela', 'fogueira');
            if (effectValue && effectValue !== 'none') {
                light.classList.add(effectValue);
            }
        }


        function selectLight(light) {
            // Deseleciona o token, se houver
            deselectAll();
            
            if (selectedLight && selectedLight !== light) {
                selectedLight.classList.remove('selected');
            }
            selectedLight = light;
            selectedLight.classList.add('selected');
            
            // Preenche o painel
            lightColorInput.value = light.dataset.color;
            lightSizeSlider.value = light.dataset.size;
            lightBlurSlider.value = light.dataset.blur;
            lightSizeLabel.textContent = `${light.dataset.size}px`;
            lightBlurLabel.textContent = `${light.dataset.blur}px`;
            lightEffectSelect.value = light.dataset.effect || 'none';
            
            // Mostra o painel
            lightConfigPanel.classList.remove('translate-x-full');
            lightConfigPanel.classList.add('translate-x-0');
        }
        
        function deselectAllLights() {
             if (selectedLight) {
                selectedLight.classList.remove('selected');
            }
            selectedLight = null;
            lightConfigPanel.classList.add('translate-x-full'); 
            lightConfigPanel.classList.remove('translate-x-0');
        }
        
        // Listeners do painel de luz
        closeLightPanelBtn.addEventListener('click', deselectAllLights);
        
        deleteLightBtn.addEventListener('click', () => {
            if (selectedLight) {
                selectedLight.remove();
                deselectAllLights();
                showNotification("Luz removida", "error");
            }
        });
        
        lightColorInput.addEventListener('input', (e) => {
            if(selectedLight) {
                selectedLight.dataset.color = e.target.value;
                applyLightEffect(selectedLight);
            }
        });
        lightSizeSlider.addEventListener('input', (e) => {
            if(selectedLight) {
                selectedLight.dataset.size = e.target.value;
                lightSizeLabel.textContent = `${e.target.value}px`;
                applyLightEffect(selectedLight);
            }
        });
        lightBlurSlider.addEventListener('input', (e) => {
            if(selectedLight) {
                selectedLight.dataset.blur = e.target.value;
                lightBlurLabel.textContent = `${e.target.value}px`;
                applyLightEffect(selectedLight);
            }
        });
        
        lightEffectSelect.addEventListener('input', (e) => {
            if(selectedLight) {
                selectedLight.dataset.effect = e.target.value;
                applyLightAnimation(selectedLight, e.target.value);
            }
        });

        
        // Arrastar Luz
        let activeLight = null;
        let isDragLight = false;
        function startDragLight(e) {
            if (document.body.classList.contains('ui-hidden')) return; // Bloqueia no modo oculto
            e.stopPropagation();
            // Ignora se for botão do meio
            if (e.button === 1) return;
            
            if (e.type === 'touchstart') {
                e.preventDefault();
                lastTouchCoords = getEventCoords(e);
            }
            else e.preventDefault();
            
            activeLight = e.target.closest('.dynamic-light');
            if (!activeLight) return;

            activeLight.style.cursor = 'grabbing';
            isDragLight = true;
            selectLight(activeLight);
        }
        
        function dragLight(e) {
            if (!activeLight || !isDragLight) return;

            let movementX = 0;
            let movementY = 0;

            if (e.type === 'touchmove') {
                e.preventDefault();
                const coords = getEventCoords(e);
                if (lastTouchCoords) {
                    movementX = coords.x - lastTouchCoords.x;
                    movementY = coords.y - lastTouchCoords.y;
                }
                lastTouchCoords = coords;
            } else {
                movementX = e.movementX;
                movementY = e.movementY;
            }
            
            const worldDeltaX = movementX / scale;
            const worldDeltaY = movementY / scale;

            const currentLeft = parseFloat(activeLight.style.left);
            const currentTop = parseFloat(activeLight.style.top);

            activeLight.style.left = `${currentLeft + worldDeltaX}px`;
            activeLight.style.top = `${currentTop + worldDeltaY}px`;
            
            // Atualiza sombras
            applyTokenFilters(); 
        }

        function endDragLight(e) {
            if (activeLight) {
                activeLight.style.cursor = 'grab';
            }
            activeLight = null;
            isDragLight = false;
            lastTouchCoords = null;
        }

        
        // --- Lógica do Painel de Atalhos ---
        shortcutsToggleBtn.addEventListener('click', () => {
            shortcutsModal.classList.toggle('hidden');
        });
        closeShortcutsBtn.addEventListener('click', () => {
            shortcutsModal.classList.add('hidden');
        });

        // --- Listener de Teclado Unificado ---
        document.addEventListener('keydown', (e) => {
            // Se estiver a digitar num input ou select, ignora TODOS os atalhos
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') {
                return;
            }
            
            if (isTransforming) return; // Ignora atalhos enquanto transforma

            const key = e.key.toLowerCase();

            // Atalhos que funcionam SEMPRE
            switch (key) {
                case 'f':
                    document.body.classList.toggle('ui-hidden');
                    if (document.body.classList.contains('ui-hidden')) {
                        scalerUI.classList.add('hidden'); 
                        hideTransformBox(); // Esconde a caixa
                        deselectAllLights(); // Esconde painel de luz
                    } else {
                        if (selectedToken) {
                            scalerUI.classList.remove('hidden');
                            updateScalerUIPosition();
                            showTransformBox(selectedToken); // Mostra a caixa
                        } else if (selectedLight) {
                            selectLight(selectedLight); // Mostra painel de luz
                        }
                    }
                    e.preventDefault(); // Evita o "Find" do browser
                    return; 

                case 'd': // D de Dados
                    diceToggleBtn.click();
                    e.preventDefault();
                    return;

                case 'e': // E de Esconder Mapa
                    mapCoverToggleBtn.click(); 
                    e.preventDefault();
                    return;

                case 'g': // G de Guardar Cena
                    saveStateBtn.click(); 
                    e.preventDefault();
                    return;
                
                case 'i': // I de Inventário
                    inventoryToggleBtn.click();
                    e.preventDefault();
                    return;
                
                case 'l': // L de Luz
                    if (document.body.classList.contains('ui-hidden')) return; // Bloqueia no modo oculto
                    lightToolBtn.click();
                    e.preventDefault();
                    return;
                
                case 'h': // H de Help/Ajuda
                    shortcutsModal.classList.toggle('hidden');
                    e.preventDefault();
                    return;
            }

            // Atalhos que dependem de um TOKEN SELECIONADO
            if (selectedToken) {
                const keyNum = parseInt(key);
                // Verifica se a tecla é um número entre 1 e 4
                if (!isNaN(keyNum) && keyNum >= 1 && keyNum <= 4) {
                    e.preventDefault(); 
                    
                    const stateKey = 'state' + keyNum;
                    const newImageUrl = selectedToken.dataset[stateKey];

                    if (newImageUrl && newImageUrl.trim() !== '') {
                        // Atualiza todas as camadas
                        const imageLayer = selectedToken.querySelector('.token-image-layer');
                        const lightOverlay = selectedToken.querySelector('.token-light-overlay');
                        const animOverlay = selectedToken.querySelector('.token-overlay');
                        
                        if (imageLayer) imageLayer.style.backgroundImage = newImageUrl;
                        if (imageLayer) imageLayer.style.maskImage = newImageUrl;
                        if (lightOverlay) lightOverlay.style.maskImage = newImageUrl;
                        if (animOverlay) animOverlay.style.maskImage = newImageUrl;
                    }
                    return; // Fim da ação de estado
                }
                
                // Atalho para Deletar
                if (key === 'delete') {
                    e.preventDefault();
                    quickDeleteBtn.click(); // Simula o clique no novo botão vermelho
                }
            }
            
            // Atalho para Deletar LUZ
            if (selectedLight && key === 'delete') {
                if (document.body.classList.contains('ui-hidden')) return; // Bloqueia no modo oculto
                e.preventDefault();
                deleteLightBtn.click();
            }
        });
        
        // --- Funções Auxiliares ---

        function updateCanvasTransform() {
            canvasContainer.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
            if (selectedToken) {
                if (!document.body.classList.contains('ui-hidden')) {
                    updateScalerUIPosition();
                }
                showTransformBox(selectedToken); // Atualiza a caixa no pan/zoom
            }
            // Atualiza sombras (REMOVIDO, agora só no drag do token/luz)
            // applyTokenFilters();
        }

        // --- Inicialização ---
        resizeAndResetMapCover(3000, 3000);
        mapCoverCanvas.style.opacity = '0'; // Começa com o mapa revelado

    </script>
</body>
</html>



